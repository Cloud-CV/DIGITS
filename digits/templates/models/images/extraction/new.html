{# Copyright (c) 2014-2015, NVIDIA CORPORATION.  All rights reserved. #}

{% from "helper.html" import print_flashes %}

{% extends "layout.html" %}

{% block title %}
Loading Pretrained CaffeModel
{% endblock %}

{% block nav %}
<li class="active"><a href="{{url_for('feature_extraction_model_new')}}?workspace={{ workspace.workspace_hash }}">New Model</a></li>
{% endblock %}

{% block content %}

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
        namespace = ''; // change to an empty string to use the global namespace
        var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

        socket.on('my progressbar', function(msg) {
            $( "#progressbar" ).progressbar({
                value: msg.percent
            });
            // $('#log').append('<br>Completed #' + msg.percent);
        });
    });
</script>
<div class="page-header">
    <h1>Loading Pretrained Model</h1>
</div>

<form id="model-form" action="{{url_for('feature_extraction_model_create')}}?workspace={{ workspace.workspace_hash }}" enctype="multipart/form-data" method="post">
    {{ form.hidden_tag() }}

    {% if form.errors %}
        <div class="alert alert-danger">
            {% for field, errors in form.errors.items() %}
                <li>{{ field }}
                    <ul>
                        {% for e in errors %}
                            <li>{{ e }}</li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        <div class="col-sm-8">
            <h3>Load Network</h3>
            <ul class="nav nav-tabs" id="network-tabs">
            	<li class="active"><a href="#network-tab-custom" data-toggle="tab">From File</a></li>
                <li><a href="#network-tab-gist" data-toggle="tab">From Gist</a></li>
                <li><a href="#network-tab-zoo" data-toggle="tab">From CaffeZoo</a></li>
                <li><a href="#network-tab-cloud-storage" data-toggle="tab">From Cloud Storage</a></li>
            </ul>
            <div class="tab-content well">
            	<div id="network-tab-custom" class="tab-pane active">
                    <div class="form-group{{' has-error' if form.custom_network.errors}}">
                        {{form.custom_network.label}}
                        <div id="custom_network_explanation" style="display:none;">
                            <h1>Specifying a custom network</h1>
                            <p>
                            You should enter a train_val network here. Some cleanup is done for you automatically:
                            <ul>
                                <li>
                                The <i>num_output</i> for each <b>InnerProduct</b> layer which is a network output gets set to the number of labels in the chosen dataset.
                                </li>
                                <li>
                                Any <b>Accuracy</b> layers with <i>top_k</i> &gt;= num_labels is removed automatically.
                                </li>
                            </ul>
                            </p>
                            The deploy network will be created for you automatically. Once caffe implements their "all-in-one" nets feature, you will be able to specify which layers to include in the deploy file. Until then, these things are done automatically:
                            <ul>
                                <li>
                                The last <b>SoftmaxWithLoss</b> layer is replaced with a <b>Softmax</b> layer.
                                </li>
                                <li>
                                All other loss layers and accuracy layers are removed.
                                </li>
                            </ul>
                            </p>
                        </div>
                        <a href=# onClick="bootbox.alert($('#custom_network_explanation').html()); return false;"><span class="glyphicon glyphicon-question-sign"></span></a>
                        {{form.custom_network(class='form-control', rows=10)}}
                    </div>
                    <div class="form-group{{' has-error' if form.custom_network_snapshot.errors}}">
                        {{form.custom_network_snapshot.label}}
                        <div class="input-group">
                            {{form.custom_network_snapshot(class='form-control')}}
                            <span name="pretrained_model_explanation"
                                class="input-group-addon explanation-tooltip glyphicon glyphicon-question-sign"
                                data-container="body"
                                title="Path to pretrained model file. Only edit this field if you understand how fine-tuning works in caffe"
                            ></span>
                        </div>
                    </div>
                </div>
                <div id="network-tab-gist" class="tab-pane">
                    <div class="form-group{{' has-error' if form.custom_network.errors}}">
                        {{form.custom_network.label}}
                        <div id="custom_network_explanation" style="display:none;">
                            <h1>Specifying a custom network</h1>
                            <p>
                            You should enter a train_val network here. Some cleanup is done for you automatically:
                            <ul>
                                <li>
                                The <i>num_output</i> for each <b>InnerProduct</b> layer which is a network output gets set to the number of labels in the chosen dataset.
                                </li>
                                <li>
                                Any <b>Accuracy</b> layers with <i>top_k</i> &gt;= num_labels is removed automatically.
                                </li>
                            </ul>
                            </p>
                            The deploy network will be created for you automatically. Once caffe implements their "all-in-one" nets feature, you will be able to specify which layers to include in the deploy file. Until then, these things are done automatically:
                            <ul>
                                <li>
                                The last <b>SoftmaxWithLoss</b> layer is replaced with a <b>Softmax</b> layer.
                                </li>
                                <li>
                                All other loss layers and accuracy layers are removed.
                                </li>
                            </ul>
                            </p>
                        </div>
                        <a href=# onClick="bootbox.alert($('#custom_network_explanation').html()); return false;"><span class="glyphicon glyphicon-question-sign"></span></a>
                        {{form.custom_network(class='form-control', rows=10)}}
                    </div>
                    <div class="form-group{{' has-error' if form.gist_id.errors}}">
                        {{form.gist_id.label}}
                        <div class="input-group">
                            {{form.gist_id(class='form-control')}}
                            <span name="pretrained_model_gist_explanation"
                                class="input-group-addon explanation-tooltip glyphicon glyphicon-question-sign"
                                data-container="body"
                                title="Gist ID of the pretrained model from the caffezoo"
                            ></span>
                        </div>
                    </div>
                </div>
                <div id="network-tab-cloud-storage" class="tab-pane">
                    <div class="form-group{{' has-error' if form.custom_network.errors}}">
                        {{form.custom_network.label}}
                        <div id="custom_network_explanation_for_cloud_storage" style="display:none;">
                            <h1>Specifying a custom network</h1>
                            <p>
                            You should enter a train_val network here. Some cleanup is done for you automatically:
                            <ul>
                                <li>
                                The <i>num_output</i> for each <b>InnerProduct</b> layer which is a network output gets set to the number of labels in the chosen dataset.
                                </li>
                                <li>
                                Any <b>Accuracy</b> layers with <i>top_k</i> &gt;= num_labels is removed automatically.
                                </li>
                            </ul>
                            </p>
                            The deploy network will be created for you automatically. Once caffe implements their "all-in-one" nets feature, you will be able to specify which layers to include in the deploy file. Until then, these things are done automatically:
                            <ul>
                                <li>
                                The last <b>SoftmaxWithLoss</b> layer is replaced with a <b>Softmax</b> layer.
                                </li>
                                <li>
                                All other loss layers and accuracy layers are removed.
                                </li>
                            </ul>
                            </p>
                            <p>Format for giving path in cloud storage:
                            <ul>
                                <li>s3://bucket_name:/path/to/directory/</li>
                                <li>dropbox:/path/to/directory/</li>
                            </ul>
                            </p>
                        </div>
                        <a href=# onClick="bootbox.alert($('#custom_network_explanation_for_cloud_storage').html()); return false;"><span class="glyphicon glyphicon-question-sign"></span></a>
                        {{form.custom_network(class='form-control', rows=10)}}
                    </div>
                    <div class="form-group{{' has-error' if form.custom_network_snapshot.errors}}">
                        {{form.custom_network_snapshot.label}}
                        <div class="input-group">
                            {{form.custom_network_snapshot(class='form-control')}}
                            <span name="pretrained_model_explanation"
                                class="input-group-addon explanation-tooltip glyphicon glyphicon-question-sign"
                                data-container="body"
                                title="Path to pretrained model file. Only edit this field if you understand how fine-tuning works in caffe"
                            ></span>
                        </div>
                    </div>
                </div>
                <div id="network-tab-zoo" class="tab-pane">
                    <div class="form-group{{' has-error' if form.caffezoo_model.errors}}">
                        {{form.caffezoo_model.label}}
                        <div class="input-group">
                            {{form.caffezoo_model(class='form-control')}}
                            <span name="pretrained_caffezoo_model_explanation"
                                class="input-group-addon explanation-tooltip glyphicon glyphicon-question-sign"
                                data-container="body"
                                title="Path to gist folder of the pretrained model from the caffezoo"
                            ></span>
                        </div>
                    </div>
                </div>
            	<div>
                    <div class="form-group{{' has-error' if form.mean_file.errors}}">
		                {{form.mean_file.label}}
		                <div class="input-group">
		                    {{form.mean_file(class='form-control')}}
		                    <span name="mean_file_explanation"
		                        class="input-group-addon explanation-tooltip glyphicon glyphicon-question-sign"
		                        data-container="body"
		                        title="The image used to perform mean subtration in classification tasks."
		                    ></span>
		                </div>
		            </div>
		            <div class="form-group{{' has-error' if form.model_name.errors}}">
		                {{form.model_name.label}}
		                <div class="input-group">
		                    {{form.model_name(class='form-control')}}
		                    <span name="model_name_explanation"
		                        class="input-group-addon explanation-tooltip glyphicon glyphicon-question-sign"
		                        data-container="body"
		                        title="An identifier, later used to refer to this model in the Application."
		                    ></span>

		                </div>
		            </div>
		            <input type="submit" name="create-model" class="btn btn-primary" value="Create">
		        </div>
            </div>
            {{ form.method(style="display:none;") }}
            <script>
function updateNetworkTab(method) {
    $('select[name=method]').val(method);
}
$('#network-tabs a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        parts = e.target.href.split('-');
        updateNetworkTab( parts[parts.length-1] );
        });
$('#network-tabs a[href="#network-tab-custom"]').tab('show');
//$('#network-tabs a[href="#network-tab-'+$("#method").val()+'"]').tab('show');
            </script>
            <script type="text/javascript">
                function importCustomNetworkSnapshot(){
                    var customNetworkSnapshot = $('#network-tab-cloud-storage .form-group #custom_network_snapshot').val();
                    console.log("custom network working" + customNetworkSnapshot);
                    if (customNetworkSnapshot.indexOf('s3') > -1 || customNetworkSnapshot.indexOf('dropbox') > -1 || customNetworkSnapshot.indexOf('gdrive') > -1){
                            console.log("Inside the cloudstorage check");
                        if ($('#network-tab-cloud-storage').hasClass('active')){
                            console.log("Inside main if");
                            $('#progressModal').modal('show');
                            $.ajax(
                            {
                                type: 'POST',
                                url: "http://deshraj.com:8000/api/download/",
                                dataType: "json",
                                // async: false,
                                data: {
                                    source_path: $('#network-tab-cloud-storage .form-group #custom_network_snapshot').val(),
                                    dest_path:"/home/digits_downloads/",
                                    session_id: '{{ request.cookies.get("sessionid") }}',
                                },
                                success: function(result){
                                    $('#progressModal').modal('hide');
                                    if(result['error']){
                                        alert(result['error']);
                                    }
                                    $('#network-tab-cloud-storage .form-group #custom_network_snapshot').val(result['dest_path']);
                                    $('#custom_network_snapshot').val(result['dest_path']);
                                },
                                error: function(jqXHR, textStatus, errorThrown){
                                    $('#progressModal').modal('hide');
                                    alert(textStatus);
                                }
                            });
                        }
                    }
                }

                function importCustomNetwork(){
                    var customNetwork = $('#network-tab-cloud-storage .form-group #custom_network').val();
                    console.log("custom network working" + customNetwork);
                    if (customNetwork.indexOf('s3') > -1 || customNetwork.indexOf('dropbox') > -1 || customNetwork.indexOf('gdrive') > -1){
                            console.log("Inside the cloudstorage check");
                        if ($('#network-tab-cloud-storage').hasClass('active')){
                            console.log("Inside main if");
                            $('#progressModal').modal('show');
                            $.ajax(
                            {
                                type: 'POST',
                                url: "http://deshraj.com:8000/api/download/",
                                dataType: "json",
                                // async: false,
                                data: {
                                    source_path: $('#network-tab-cloud-storage .form-group #custom_network').val(),
                                    dest_path:"/home/digits_downloads/",
                                    session_id: '{{ request.cookies.get("sessionid") }}',
                                },
                                success: function(result){
                                    $('#progressModal').modal('hide');
                                    if(result['error']){
                                        alert(result['error']);
                                    }
                                    $('#network-tab-cloud-storage .form-group #custom_network').val(result['dest_path']);
                                    $('#custom_network').val(result['dest_path']);
                                },
                                error: function(jqXHR, textStatus, errorThrown){
                                    $('#progressModal').modal('hide');
                                    alert(textStatus);
                                }
                            });
                        }
                    }
                }
                function importMeanImage(){
                    var meanFile = $("#mean_file").val();
                    console.log("mean file working" + meanFile);
                    if (meanFile.indexOf('s3') > -1 || meanFile.indexOf('dropbox') > -1 || meanFile.indexOf('gdrive') > -1){
                            console.log("Inside the cloudstorage check");
                        if ($('#network-tab-cloud-storage').hasClass('active')){
                            console.log("Inside main if");
                            $('#progressModal').modal('show');
                            $.ajax(
                            {
                                type: 'POST',
                                url: "http://deshraj.com:8000/api/download/",
                                dataType: "json",
                                // async: false,
                                data: {
                                    source_path: $("#mean_file").val(),
                                    dest_path:"/home/digits_downloads/",
                                    session_id: '{{ request.cookies.get("sessionid") }}',
                                },
                                success: function(result){
                                    $('#progressModal').modal('hide');
                                    if(result['error']){
                                        alert(result['error']);
                                    }
                                    $("#mean_file").val(result['dest_path']);
                                },
                                error: function(jqXHR, textStatus, errorThrown){
                                    $('#progressModal').modal('hide');
                                    alert(textStatus);
                                }
                            });
                        }
                    }
                }
                $("#mean_file").focusout(function(){
                    importMeanImage();
                });
                $("#network-tab-cloud-storage .form-group #custom_network_snapshot").focusout(function(){
                    importCustomNetworkSnapshot();
                });
                $('#network-tab-cloud-storage .form-group #custom_network').focusout(function(){
                    importCustomNetwork();
                });
            </script>
        </div>    
    </div>
</form>
<div id="progressModal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Fetching Data from Cloud Storages</h4>
      </div>
      <div class="modal-body">
        <div id="progressbar"></div>
        <p>Please wait while we are fetching data from Cloud Storage. You will be redirected automatically once download completes.</p><p>Note: This may take some time.</p>
      </div>
    </div>
  </div>
</div>
<script>
    $( "#progressbar" ).progressbar({
      value: false
    });
</script>
{% endblock %}
